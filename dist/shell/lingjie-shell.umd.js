(function(j){typeof define=="function"&&define.amd?define(j):j()})(function(){"use strict";function j(){return typeof crypto=="undefined"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)}):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const $=(e,t)=>{const n=e.document.querySelector("title"),u=e.MutationObserver||e.WebKitMutationObserver;n&&u&&new u(()=>{t(e.document.title)}).observe(n,{subtree:!0,characterData:!0,childList:!0}),t(e.document.title)},G=()=>j(),st=()=>j(),M=(e,t,n,u,a,m)=>({__microapp_traced_state__:{historyTracerId:n,id:st(),url:new URL(e,window.location.href).href,title:u,action:a,data:m},...t}),ot=e=>`__history_tracer_${e}`,J=(e,t)=>{var E,b;const n=(E=t==null?void 0:t.historyTracerId)!=null?E:G(),u=(b=t==null?void 0:t.storageKey)!=null?b:ot(n),a=e.history,m=a.pushState.bind(a),v=a.replaceState.bind(a),y=a.back.bind(a),A=a.forward.bind(a),I=a.go.bind(a),P=(i,s,d)=>{const _=new URL(i,e.location.href).href;return M(_,s,n,document.title,d,t.data)},x=(()=>{const i=e.sessionStorage.getItem(u);if(i)try{return JSON.parse(i)}catch{}})();let l=P(e.location.href,e.history.state,"default");a.replaceState(l,"");let w=(()=>{var s;const i=(s=x==null?void 0:x.historyStateList)!=null?s:[];return i.length>0?i:[l]})();const X=i=>{e.sessionStorage.setItem(u,JSON.stringify(i))},O=()=>{var i;(i=e.sessionStorage)==null||i.removeItem(u)},C=i=>{var k;const s=l,d=f();l=i;const _=w.slice(d+1);w=w.slice(0,d+1),w.push(i),w.length>50&&_.push(w.shift()),(k=t==null?void 0:t.onPushState)==null||k.call(t,l,s,_)},F=i=>{var _;const s=l,d=f();l=i,w[d]=i,(_=t==null?void 0:t.onReplaceState)==null||_.call(t,l,s)},it=(i,s,d=e.location.href)=>{const _=P(d,i,"push");try{return m(_,s,d)}finally{C(_)}},U=(i,s,d=e.location.href)=>{const _=P(d,i,"replace");try{return v(_,s,d)}finally{F(_)}},r=()=>{var s;return f()===0&&((s=t==null?void 0:t.onLastBack)==null||s.call(t,l)),y.call(a)},c=()=>{var s;return f()===w.length-1&&((s=t==null?void 0:t.onLastForward)==null||s.call(t,l)),A.call(a)},o=i=>{var d,_;const s=f();return s+i<0?(d=t==null?void 0:t.onLastBack)==null||d.call(t,l):s+i>w.length-1&&((_=t==null?void 0:t.onLastForward)==null||_.call(t,l)),I(i)},f=()=>g(l),h=(i,s)=>{const d=g(i);return g(s)-d},g=i=>w.findIndex(s=>s.__microapp_traced_state__.id===i.__microapp_traced_state__.id);try{a.pushState=it,a.replaceState=U,a.back=r,a.forward=c,a.go=o}catch(i){console.log(i)}return e.addEventListener("popstate",i=>{var N;if(!i.state)return;const s=i.state,d=l.__microapp_traced_state__;if(s.__microapp_traced_state__.id===d.id)return;const k=h(l,s),p=l;l=s,(N=t==null?void 0:t.onPopState)==null||N.call(t,s,p,k)}),e.addEventListener("hashchange",()=>{if(!a.state){const i=e.location.href,s=P(i,a.state,"push");try{return v(s,"")}finally{C(s)}}}),e.addEventListener("beforeunload",()=>{var i,s,d,_;(i=t.shouldClear)!=null&&i.call(t)&&((s=t.onBeforeClear)==null||s.call(t),O()),(d=t.shouldSave)!=null&&d.call(t)&&((_=t.onBeforeSave)==null||_.call(t),X({historyStateList:w}))}),$(e,i=>{l.__microapp_traced_state__.title=i}),{originalGo:I,originalReplaceState:v,historyTracerId:n,getStateIndex:g,getCurrentIndex:f,getCurrentState:()=>l,clearStorage:O,getHistoryStateList:()=>w}};var S={DISAPPEAR:0,NOTHING:1,APPEAR:2,PENDING:3,DISAPPEAR_RESTART:4},Q=150,ct=function(){function e(t){t===void 0&&(t={}),this._el=document.createElement("div"),this._state=S.NOTHING,this._opts={maxWidth:"99.8%",height:"4px",duration:6e4,hideDuration:400,zIndex:"9999",color:"#ff1a59",className:"",timing:"cubic-bezier(0,1,0,1)",position:"top",container:document.body},this._rafId=null,this._timerId=null,this._promises=[],this._delayTimers=[],this.setOptions(t)}return e.prototype.setOptions=function(t){var n=B(this._opts,t);isNaN(n.maxWidth)||(n.maxWidth+="px"),isNaN(n.height)||(n.height+="px"),n.zIndex=String(n.zIndex),this._el.className=n.className,this._css(B({height:n.height,background:n.color,zIndex:n.zIndex,position:"",left:"",top:"",bottom:""},{top:{position:"fixed",top:"0",left:"0"},bottom:{position:"fixed",bottom:"0",left:"0"}}[n.position]))},e.prototype._css=function(t){B(this._el.style,t)},Object.defineProperty(e.prototype,"isInProgress",{get:function(){return this._state!==0},enumerable:!1,configurable:!0}),e.prototype.start=function(){var t=this;switch(this._state){case S.APPEAR:case S.PENDING:case S.DISAPPEAR_RESTART:return;case S.DISAPPEAR:this._state=S.DISAPPEAR_RESTART;return}this._state=S.APPEAR;var n=this._opts,u="width ".concat(n.duration,"ms ").concat(n.timing);this._css({width:"0",opacity:"1",transition:u,webkitTransition:u}),n.container.appendChild(this._el),this._rafId=requestAnimationFrame(function(){t._rafId=requestAnimationFrame(function(){t._rafId=null,t._state=S.PENDING,t._css({width:t._opts.maxWidth})})})},e.prototype.end=function(t){var n=this;switch(t===void 0&&(t=!1),this._promises=[],this._delayTimers.splice(0).forEach(clearTimeout),this._state){case S.NOTHING:return;case S.APPEAR:this._state=S.NOTHING,cancelAnimationFrame(this._rafId),this._rafId=null,D(this._el);return;case S.DISAPPEAR:case S.DISAPPEAR_RESTART:t?(this._state=S.NOTHING,clearTimeout(this._timerId),this._timerId=null,D(this._el)):this._state=S.DISAPPEAR;return}if(t){this._state=S.NOTHING,D(this._el);return}this._state=S.DISAPPEAR;var u=this._opts,a="width 50ms, opacity ".concat(u.hideDuration,"ms ").concat(Q,"ms");this._css({width:"100%",opacity:"0",transition:a,webkitTransition:a}),this._timerId=setTimeout(function(){n._timerId=null;var m=n._state===S.DISAPPEAR_RESTART;n._state=S.NOTHING,D(n._el),m&&n.start()},u.hideDuration+Q)},e.prototype.promise=function(t,n){var u=this,a=n===void 0?{}:n,m=a.delay,v=m===void 0?0:m,y=a.min,A=y===void 0?100:y,I,P=function(){A>0&&(t=Promise.all([t,new Promise(function(l){return setTimeout(l,A)})]).then(function(l){var R=l[0];return R})),u._promises.push(t),u.start()},T=function(){var l=u._delayTimers;l.splice(l.indexOf(I)>>>0,1),I=null};v>0?this._delayTimers.push(I=setTimeout(function(){T(),P()},v)):P();var x=function(){if(I){clearTimeout(I),T();return}var l=u._promises,R=l.indexOf(t);~R&&(l.splice(R,1),l.length===0&&u.end())};return t.then(function(l){return x(),l},function(l){return x(),Promise.reject(l)})},e}();function B(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}function D(e){e.parentNode&&e.parentNode.removeChild(e)}const H=(e,t)=>{if(ut(e))return{ok:!1};for(const n of t){const u=Y(n,e);if(u.ok)return u}return{ok:!1}},ut=e=>typeof window=="undefined"?!1:new URL(e,window.location.href).origin!==window.location.origin,Y=(e,t)=>{if(typeof e=="function"){if(e(t))return{ok:!0}}else if(e instanceof RegExp){if(e.test(t))return{ok:!0}}else if(typeof e=="object")return lt(e,t);return{ok:!1}},lt=(e,t)=>{if(!Y(e.test,t).ok)return{ok:!1};if(e.disabled)return{ok:!1};if(e.originList){const u=new URL(t).origin;if(!e.originList.includes(u))return{ok:!1}}return{ok:!0,rule:e}},Z=new ct({height:"2px",color:"#3870e1",duration:5e3,timing:"ease-in-out"});let tt;const q=()=>{K(),Z.start(),clearTimeout(tt),tt=setTimeout(K,5e3)},K=()=>{Z.end(!0)},dt={isActive:e=>e.getAttribute("isActive")==="true",initialize:e=>{e.style.zIndex="-1",e.setAttribute("isActive","false")},activate:e=>{e.style.zIndex="0",e.setAttribute("isActive","true")},inactivate:e=>{e.style.zIndex="-1",e.setAttribute("isActive","false")},destroy:e=>{e.remove()}},ft={isActive:e=>e.getAttribute("isActive")==="true",initialize:(e,t)=>{e.style.boxShadow="",e.style.willChange="transform",e.style.transition="transform 300ms ease-in-out",t===0?e.style.transform="translateX(0)":e.style.transform="translateX(100%)",e.setAttribute("isActive","false")},activate:e=>{e.style.boxShadow="rgba(0, 0, 0, 0.13) -4px 0px 5px 0px",e.style.transform="translateX(0)",e.setAttribute("isActive","true")},inactivate:e=>{e.style.boxShadow="",e.setAttribute("isActive","false")},destroy:e=>{e.style.boxShadow="rgba(0, 0, 0, 0.13) -4px 0px 5px 0px",e.style.transform="translateX(100%)",setTimeout(()=>{e.remove()},400)}},W={show:"lingjie:show",hide:"lingjie:hide",back:"lingjie:back"},et={removeIframe:"lingjie:remove-iframe"},L={enable:"data-lingjie-enable",disable:"data-lingjie-disable",backAction:"data-lingjie-back-action",waitFor:"data-lingjie-wait-for",timeout:"data-lingjie-timeout"},ht=e=>{const t={rules:[()=>!1],...dt,...e},n=J(window,{storageKey:"__microapp_main_frame_history__",data:{attrs:{}},onPushState:(r,c,o)=>{q();for(const f of o)x(P(f.__microapp_traced_state__.historyTracerId))},onReplaceState:(r,c)=>{if(V(r.__microapp_traced_state__.url,c.__microapp_traced_state__.url))return;m().length>0&&q(),T(r)},onPopState:(r,c,o)=>{V(r.__microapp_traced_state__.url,c.__microapp_traced_state__.url)||(q(),T(r,o))},shouldSave:()=>!0}),u=()=>{const r=n.getHistoryStateList(),c=n.getCurrentIndex(),o=r.slice(c+1,r.length);for(const f of o)x(P(f.__microapp_traced_state__.historyTracerId))},a=()=>document.body,m=()=>{const c=a().querySelectorAll("iframe");return Array.from(c)},v=r=>{const c=m().find(o=>o.contentWindow===r);if(!c)throw new Error(`iframe not found: ${r}`);return c},y=r=>{var o;const c=m();for(;c.length>r;)(o=c.shift())==null||o.remove()},A=(r,c=0)=>{const o=()=>{var f,h;return(f=r.contentWindow)!=null&&f.location.href?((h=r.contentWindow)==null?void 0:h.location.href)==="about:blank":!0};nt({condition:()=>!o(),action:()=>{r.contentWindow&&C(r.contentWindow,c)},timeoutAction:()=>{r.contentWindow&&(o()?r.contentWindow.location.replace(r.src):C(r.contentWindow,c))}})},I=(r,c,o)=>{var E,b,i,s,d,_,k;const f=mt(r,c),h=a(),g=H(r,t.rules);g.ok&&(o={[L.backAction]:(b=(E=g.rule)==null?void 0:E.backAction)!=null?b:"",[L.timeout]:(d=(s=(i=g.rule)==null?void 0:i.timeout)==null?void 0:s.toString())!=null?d:"",[L.waitFor]:(k=(_=g.rule)==null?void 0:_.waitFor)!=null?k:"",...o});for(const p in o)f.setAttribute(p,o[p]);t.initialize(f,m().length),m().length===0&&t.activate(f,0),h.appendChild(f),A(f),y(10)},P=r=>document.getElementById(r),T=(r,c=0)=>{const o=P(r.__microapp_traced_state__.historyTracerId);if(o)if(o.contentWindow){const f=l();if(o===f)return;if(f&&c<0&&f.getAttribute(L.backAction)==="reload"){o.contentWindow.location.reload(),A(o,c);return}R(o,c)}else A(o,c);else{const f=r.__microapp_traced_state__;I(f.url,f.historyTracerId,r.__microapp_traced_state__.data.attrs)}},x=r=>{r==null||r.dispatchEvent(new CustomEvent(et.removeIframe))},l=()=>{for(const r of m())if(t.isActive(r))return r},R=(r,c=0)=>{var f,h,g;const o=l();t.activate(r,c),o&&(o!==r&&(t.inactivate(o,c),(f=o.contentWindow)==null||f.dispatchEvent(new Event(W.hide))),(h=r.contentWindow)==null||h.dispatchEvent(new Event(W.show)),c<0&&((g=r.contentWindow)==null||g.dispatchEvent(new Event(W.back)))),K(),c<0&&u()},w=r=>{$(r,c=>{window.document.title=c})},X=r=>{const c=h=>{var b,i,s,d;if(!h)return{type:"non-exist"};const g=h.getAttribute("href");if(!g)return{type:"non-href"};if(g.startsWith("#"))return{type:"hash-link",target:h};if(V(r.location.href,h.href))return{type:"hash-change",target:h};if(r.location.href===h.href)return{type:"same-link",target:h};if(h.getAttribute("target")==="_blank")return{type:"open-new-tab",target:h};const E=H(h.href,t.rules);return E.ok?{type:"matched-link",target:h,backAction:(b=E.rule)==null?void 0:b.backAction,waitFor:(i=E.rule)==null?void 0:i.waitFor,timeout:(d=(s=E.rule)==null?void 0:s.timeout)==null?void 0:d.toString()}:{type:"unmatched-link",target:h}},o=h=>{let g=h;for(;g;){if(g.hasAttribute(L.enable))return!0;if(g.hasAttribute(L.disable))return!1;g=g.parentElement}return!0},f=h=>{var i,s,d,_;if(!h.target)return;const g=h.target,E=gt(g),b=c(E);if(o(g)||(window.location.href=((i=b.target)==null?void 0:i.href)||""),b.type==="same-link")r.location.reload();else if(b.type==="unmatched-link")window.location.href=b.target.getAttribute("href")||"";else if(b.type==="matched-link"){const k=b.target;if(k.hasAttribute("download"))return;const N=_t(k);h.preventDefault(),F(k.href,{[L.backAction]:(s=b.backAction)!=null?s:"",[L.timeout]:(d=b.timeout)!=null?d:"",[L.waitFor]:(_=b.waitFor)!=null?_:"",...N})}};r.document.addEventListener("click",f)};let O=!1;window.addEventListener("beforeunload",()=>{O=!0});const C=(r,c=0)=>{var k;const o=v(r);if(r.lingjie){c<0&&u();return}r.lingjie=U;const f=rt(o),h=()=>n.getCurrentState().__microapp_traced_state__.historyTracerId===o.id,g=J(r,{historyTracerId:o.id,data:{attrs:f},onPushState:p=>{!h()||window.history.replaceState(p,"",r.location.href)},onReplaceState:p=>{!h()||window.history.replaceState(p,"",r.location.href)},onPopState:p=>{!h()||window.history.replaceState(p,"",r.location.href)},shouldClear:()=>O,shouldSave:()=>!O}),E=parseInt((k=o.getAttribute(L.timeout))!=null?k:"5000",10),i=(()=>{var N,z;const p=o.getAttribute(L.waitFor);if(!p){const at=H(r.location.href,t.rules);if(at.ok)return(z=(N=at.rule)==null?void 0:N.waitFor)!=null?z:"dom-ready"}return p!=null?p:"dom-ready"})(),s=p=>{if(!h())return;const N=n.getCurrentState();window.location.href!==r.location.href&&n.originalReplaceState(N,"",r.location.href),R(o,p)};let d=[];const _=(p=0)=>{nt({initialize:N=>{pt(r,E,i,z=>(d=z,N()))},condition:()=>d.includes("matched")||d.includes("timeout")?!0:i==="fcp"?d.includes("fcp"):i==="dom-ready"?d.includes("dom-ready"):i==="loaded"?d.includes("loaded"):i?!!r.document.querySelector(i):!1,action:()=>{s(p)},timeoutAction:()=>{s(p)}})};r.document.addEventListener("DOMContentLoaded",()=>{w(r)}),o.addEventListener(et.removeIframe,()=>{g.clearStorage(),t.destroy(o)}),_(c),X(r),w(r)},F=(r,c)=>{if(!H(r,t.rules).ok){window.location.href=r;return}r=new URL(r,window.location.href).href;const f=M(r,null,G(),"","default",{attrs:c!=null?c:{}});window.history.pushState(f,"",r),I(r,f.__microapp_traced_state__.historyTracerId,c)},U={replacePage:(r,c)=>{r=new URL(r,window.location.href).href;const o=M(r,null,G(),"","default",{attrs:c!=null?c:{}});window.history.replaceState(o,"",r)},addPage:F,redirect:r=>{window.location.replace(r)},goto:r=>{window.location.href=r},initWindow:C,historyTracer:n};return U},V=(e,t)=>{const{origin:n,pathname:u,hash:a}=new URL(e,window.location.href),{origin:m,pathname:v,hash:y}=new URL(t,window.location.href);return n===m&&u===v&&a!==y},mt=(e,t)=>{const n=document.createElement("iframe");return n.src=e,n.id=t,n.style.border="none",n.style.position="fixed",n.style.top="0px",n.style.left="0px",n.style.width="100%",n.style.height="100%",n.style.background="#ffffff",n},rt=(e,t={})=>{var u;const n=Object.values(L);for(const a of n)a in t||e.hasAttribute(a)&&(t[a]=(u=e.getAttribute(a))!=null?u:"");return t},_t=e=>{const t={};let n=e;for(;n;)rt(n,t),n=n.parentElement;return t},gt=e=>{let t=e;for(;t;){if(yt(t))return t;t=t.parentElement}},yt=e=>e.tagName==="A",pt=(e,t=5e3,n,u)=>{const a=[],m=[],v=()=>{for(const T of m)T.clear()},y=()=>u(a)?(v(),!0):!1;if(e.document.readyState==="interactive"){if(a.push("dom-ready"),y())return}else if(e.document.readyState==="complete"&&(a.push("dom-ready","loaded"),y()))return;if(e.PerformanceObserver){const T=e.PerformanceObserver,x=new T(l=>{l.getEntriesByName("first-contentful-paint").length>0&&(a.push("fcp"),y())});try{x.observe({type:"paint",buffered:!0}),m.push({name:"fcp",clear:()=>{x.disconnect()}})}catch{}}const A=()=>{a.includes("dom-ready")||(a.push("dom-ready"),y())};e.document.addEventListener("DOMContentLoaded",A,{once:!0}),m.push({name:"dom-ready",clear:()=>{e.document.removeEventListener("DOMContentLoaded",A)}});const I=()=>{a.includes("loaded")||(a.push("loaded"),y())};if(e.addEventListener("load",I,{once:!0}),m.push({name:"loaded",clear:()=>{e.removeEventListener("load",I)}}),n!=="loaded"&&n!=="dom-ready"&&n!=="fcp"&&n!=="timeout"){const T=e.MutationObserver;if(T){const x=new T(l=>{for(const R of l)if(R.type==="childList"&&e.document.querySelector(n)){a.push("matched"),y(),x==null||x.disconnect();return}});x.observe(e.document,{childList:!0,subtree:!0}),m.push({name:"matched",clear:()=>{x.disconnect()}})}}let P=setTimeout(()=>{a.push("timeout"),y()},isNaN(t)?5e3:t);return m.push({name:"timeout",clear:()=>{clearTimeout(P)}}),a},nt=e=>{const{initialize:t,condition:n,action:u,interval:a=200,timeout:m=5e3,timeoutAction:v}=e;let y=!1,A=!1;const I=()=>y||A?!0:(clearTimeout(T),n()?(y=!0,clearTimeout(P),u(),!0):(T=setTimeout(I,a),!1)),P=setTimeout(()=>{A=!0,v==null||v(),clearTimeout(T)},m);let T=setTimeout(I,a);t==null||t(I)};(e=>{if(window.lingjie)throw new Error("Lingjie is already initialized");let{rules:t,...n}=window.__lingjie_shell_config__;t=(t||[]).map(function(A){return A.test=new RegExp(A.test),A});const u={paramKey:"lingjie_url",useGlobalVar:!0,rules:t,...n,...e},m=new URL(window.location.href).searchParams.get(u.paramKey);if(!m)throw new Error(`${u.paramKey} is required in query string`);history.replaceState(null,"",m);let v={...u};window.innerWidth<800&&!u.turnoffSlideAnimation&&Object.assign(v,ft);const y=ht(v);return window.lingjie=y,y.replacePage(m),y})()});
