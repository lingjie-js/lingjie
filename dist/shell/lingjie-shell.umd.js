(function(C){typeof define=="function"&&define.amd?define(C):C()})(function(){"use strict";function C(){return typeof crypto=="undefined"?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)}):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))}const J=(e,t)=>{const n=e.document.querySelector("title"),u=e.MutationObserver||e.WebKitMutationObserver;n&&u&&new u(()=>{t(e.document.title)}).observe(n,{subtree:!0,characterData:!0,childList:!0}),t(e.document.title)},G=()=>C(),ot=()=>C(),B=(e,t,n,u,s,_)=>({__microapp_traced_state__:{historyTracerId:n,id:ot(),url:new URL(e,window.location.href).href,title:u,action:s,data:_},...t}),ct=e=>`__history_tracer_${e}`,Q=(e,t)=>{var g,E;const n=(g=t==null?void 0:t.historyTracerId)!=null?g:G(),u=(E=t==null?void 0:t.storageKey)!=null?E:ct(n),s=e.history,_=s.pushState.bind(s),v=s.replaceState.bind(s),y=s.back.bind(s),S=s.forward.bind(s),A=s.go.bind(s),w=(i,o,h)=>{const f=new URL(i,e.location.href).href;return B(f,o,n,document.title,h,t.data)},I=(()=>{const i=e.sessionStorage.getItem(u);if(i)try{return JSON.parse(i)}catch{}})();let l=w(e.location.href,e.history.state,"default");s.replaceState(l,"");let T=(()=>{var o;const i=(o=I==null?void 0:I.historyStateList)!=null?o:[];return i.length>0?i:[l]})();const $=i=>{e.sessionStorage.setItem(u,JSON.stringify(i))},F=()=>{var i;(i=e.sessionStorage)==null||i.removeItem(u)},O=i=>{var k;const o=l,h=a();l=i;const f=T.slice(h+1);T=T.slice(0,h+1),T.push(i),T.length>50&&f.push(T.shift()),(k=t==null?void 0:t.onPushState)==null||k.call(t,l,o,f)},j=i=>{var f;const o=l,h=a();l=i,T[h]=i,(f=t==null?void 0:t.onReplaceState)==null||f.call(t,l,o)},U=(i,o,h=e.location.href)=>{const f=w(h,i,"push");try{return _(f,o,h)}finally{O(f)}},at=(i,o,h=e.location.href)=>{const f=w(h,i,"replace");try{return v(f,o,h)}finally{j(f)}},z=()=>{var o;return a()===0&&((o=t==null?void 0:t.onLastBack)==null||o.call(t,l)),y.call(s)},r=()=>{var o;return a()===T.length-1&&((o=t==null?void 0:t.onLastForward)==null||o.call(t,l)),S.call(s)},c=i=>{var h,f;const o=a();return o+i<0?(h=t==null?void 0:t.onLastBack)==null||h.call(t,l):o+i>T.length-1&&((f=t==null?void 0:t.onLastForward)==null||f.call(t,l)),A(i)},a=()=>d(l),m=(i,o)=>{const h=d(i);return d(o)-h},d=i=>T.findIndex(o=>o.__microapp_traced_state__.id===i.__microapp_traced_state__.id);try{s.pushState=U,s.replaceState=at,s.back=z,s.forward=r,s.go=c}catch(i){console.log(i)}return e.addEventListener("popstate",i=>{var p;if(!i.state)return;const o=i.state,h=l.__microapp_traced_state__;if(o.__microapp_traced_state__.id===h.id)return;const k=m(l,o),R=l;l=o,(p=t==null?void 0:t.onPopState)==null||p.call(t,o,R,k)}),e.addEventListener("hashchange",()=>{if(!s.state){const i=e.location.href,o=w(i,s.state,"push");try{return v(o,"")}finally{O(o)}}}),e.addEventListener("beforeunload",()=>{var i,o,h,f;(i=t.shouldClear)!=null&&i.call(t)&&((o=t.onBeforeClear)==null||o.call(t),F()),(h=t.shouldSave)!=null&&h.call(t)&&((f=t.onBeforeSave)==null||f.call(t),$({historyStateList:T}))}),J(e,i=>{l.__microapp_traced_state__.title=i}),{originalGo:A,originalReplaceState:v,historyTracerId:n,getStateIndex:d,getCurrentIndex:a,getCurrentState:()=>l,clearStorage:F,getHistoryStateList:()=>T}},ut=(e,t)=>{const n=e.document.querySelector("head > link[rel='icon']"),u=e.MutationObserver||e.WebKitMutationObserver;n&&u&&new u(()=>{t(n.href||"")}).observe(n,{subtree:!0,characterData:!0,childList:!0}),t((n==null?void 0:n.href)||"")};var b={DISAPPEAR:0,NOTHING:1,APPEAR:2,PENDING:3,DISAPPEAR_RESTART:4},Y=150,lt=function(){function e(t){t===void 0&&(t={}),this._el=document.createElement("div"),this._state=b.NOTHING,this._opts={maxWidth:"99.8%",height:"4px",duration:6e4,hideDuration:400,zIndex:"9999",color:"#ff1a59",className:"",timing:"cubic-bezier(0,1,0,1)",position:"top",container:document.body},this._rafId=null,this._timerId=null,this._promises=[],this._delayTimers=[],this.setOptions(t)}return e.prototype.setOptions=function(t){var n=q(this._opts,t);isNaN(n.maxWidth)||(n.maxWidth+="px"),isNaN(n.height)||(n.height+="px"),n.zIndex=String(n.zIndex),this._el.className=n.className,this._css(q({height:n.height,background:n.color,zIndex:n.zIndex,position:"",left:"",top:"",bottom:""},{top:{position:"fixed",top:"0",left:"0"},bottom:{position:"fixed",bottom:"0",left:"0"}}[n.position]))},e.prototype._css=function(t){q(this._el.style,t)},Object.defineProperty(e.prototype,"isInProgress",{get:function(){return this._state!==0},enumerable:!1,configurable:!0}),e.prototype.start=function(){var t=this;switch(this._state){case b.APPEAR:case b.PENDING:case b.DISAPPEAR_RESTART:return;case b.DISAPPEAR:this._state=b.DISAPPEAR_RESTART;return}this._state=b.APPEAR;var n=this._opts,u="width ".concat(n.duration,"ms ").concat(n.timing);this._css({width:"0",opacity:"1",transition:u,webkitTransition:u}),n.container.appendChild(this._el),this._rafId=requestAnimationFrame(function(){t._rafId=requestAnimationFrame(function(){t._rafId=null,t._state=b.PENDING,t._css({width:t._opts.maxWidth})})})},e.prototype.end=function(t){var n=this;switch(t===void 0&&(t=!1),this._promises=[],this._delayTimers.splice(0).forEach(clearTimeout),this._state){case b.NOTHING:return;case b.APPEAR:this._state=b.NOTHING,cancelAnimationFrame(this._rafId),this._rafId=null,D(this._el);return;case b.DISAPPEAR:case b.DISAPPEAR_RESTART:t?(this._state=b.NOTHING,clearTimeout(this._timerId),this._timerId=null,D(this._el)):this._state=b.DISAPPEAR;return}if(t){this._state=b.NOTHING,D(this._el);return}this._state=b.DISAPPEAR;var u=this._opts,s="width 50ms, opacity ".concat(u.hideDuration,"ms ").concat(Y,"ms");this._css({width:"100%",opacity:"0",transition:s,webkitTransition:s}),this._timerId=setTimeout(function(){n._timerId=null;var _=n._state===b.DISAPPEAR_RESTART;n._state=b.NOTHING,D(n._el),_&&n.start()},u.hideDuration+Y)},e.prototype.promise=function(t,n){var u=this,s=n===void 0?{}:n,_=s.delay,v=_===void 0?0:_,y=s.min,S=y===void 0?100:y,A,w=function(){S>0&&(t=Promise.all([t,new Promise(function(l){return setTimeout(l,S)})]).then(function(l){var L=l[0];return L})),u._promises.push(t),u.start()},x=function(){var l=u._delayTimers;l.splice(l.indexOf(A)>>>0,1),A=null};v>0?this._delayTimers.push(A=setTimeout(function(){x(),w()},v)):w();var I=function(){if(A){clearTimeout(A),x();return}var l=u._promises,L=l.indexOf(t);~L&&(l.splice(L,1),l.length===0&&u.end())};return t.then(function(l){return I(),l},function(l){return I(),Promise.reject(l)})},e}();function q(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e}function D(e){e.parentNode&&e.parentNode.removeChild(e)}const H=(e,t)=>{if(dt(e))return{ok:!1};for(const n of t){const u=Z(n,e);if(u.ok)return u}return{ok:!1}},dt=e=>typeof window=="undefined"?!1:new URL(e,window.location.href).origin!==window.location.origin,Z=(e,t)=>{if(typeof e=="function"){if(e(t))return{ok:!0}}else if(e instanceof RegExp){if(e.test(t))return{ok:!0}}else if(typeof e=="object")return ft(e,t);return{ok:!1}},ft=(e,t)=>{if(!Z(e.test,t).ok)return{ok:!1};if(e.disabled)return{ok:!1};if(e.originList){const u=new URL(t).origin;if(!e.originList.includes(u))return{ok:!1}}return{ok:!0,rule:e}},tt=new lt({height:"2px",color:"#3870e1",duration:5e3,timing:"ease-in-out"});let et;const K=()=>{W(),tt.start(),clearTimeout(et),et=setTimeout(W,5e3)},W=()=>{tt.end(!0)},ht={isActive:e=>e.getAttribute("isActive")==="true",initialize:e=>{e.style.zIndex="-1",e.setAttribute("isActive","false")},activate:e=>{e.style.zIndex="0",e.setAttribute("isActive","true")},inactivate:e=>{e.style.zIndex="-1",e.setAttribute("isActive","false")},destroy:e=>{e.remove()}},mt={isActive:e=>e.getAttribute("isActive")==="true",initialize:(e,t)=>{e.style.boxShadow="",e.style.willChange="transform",e.style.transition="transform 300ms ease-in-out",t===0?e.style.transform="translateX(0)":e.style.transform="translateX(100%)",e.setAttribute("isActive","false")},activate:e=>{e.style.boxShadow="rgba(0, 0, 0, 0.13) -4px 0px 5px 0px",e.style.transform="translateX(0)",e.setAttribute("isActive","true")},inactivate:e=>{e.style.boxShadow="",e.setAttribute("isActive","false")},destroy:e=>{e.style.boxShadow="rgba(0, 0, 0, 0.13) -4px 0px 5px 0px",e.style.transform="translateX(100%)",setTimeout(()=>{e.remove()},400)}},V={show:"lingjie:show",hide:"lingjie:hide",back:"lingjie:back"},rt={removeIframe:"lingjie:remove-iframe"},P={enable:"data-lingjie-enable",disable:"data-lingjie-disable",backAction:"data-lingjie-back-action",waitFor:"data-lingjie-wait-for",timeout:"data-lingjie-timeout"},_t=e=>{const t={rules:[()=>!1],...ht,...e},n=Q(window,{storageKey:"__microapp_main_frame_history__",data:{attrs:{}},onPushState:(r,c,a)=>{K();for(const m of a)I(w(m.__microapp_traced_state__.historyTracerId))},onReplaceState:(r,c)=>{if(X(r.__microapp_traced_state__.url,c.__microapp_traced_state__.url))return;_().length>0&&K(),x(r)},onPopState:(r,c,a)=>{X(r.__microapp_traced_state__.url,c.__microapp_traced_state__.url)||(K(),x(r,a))},shouldSave:()=>!0}),u=()=>{const r=n.getHistoryStateList(),c=n.getCurrentIndex(),a=r.slice(c+1,r.length);for(const m of a)I(w(m.__microapp_traced_state__.historyTracerId))},s=()=>document.body,_=()=>{const c=s().querySelectorAll("iframe");return Array.from(c)},v=r=>{const c=_().find(a=>a.contentWindow===r);if(!c)throw new Error(`iframe not found: ${r}`);return c},y=r=>{var a;const c=_();for(;c.length>r;)(a=c.shift())==null||a.remove()},S=(r,c=0)=>{const a=()=>{var m,d;return(m=r.contentWindow)!=null&&m.location.href?((d=r.contentWindow)==null?void 0:d.location.href)==="about:blank":!0};it({condition:()=>!a(),action:()=>{r.contentWindow&&j(r.contentWindow,c)},timeoutAction:()=>{r.contentWindow&&(a()?r.contentWindow.location.replace(r.src):j(r.contentWindow,c))}})},A=(r,c,a)=>{var E,i,o,h,f,k,R;const m=gt(r,c),d=s(),g=H(r,t.rules);g.ok&&(a={[P.backAction]:(i=(E=g.rule)==null?void 0:E.backAction)!=null?i:"",[P.timeout]:(f=(h=(o=g.rule)==null?void 0:o.timeout)==null?void 0:h.toString())!=null?f:"",[P.waitFor]:(R=(k=g.rule)==null?void 0:k.waitFor)!=null?R:"",...a});for(const p in a)m.setAttribute(p,a[p]);t.initialize(m,_().length),_().length===0&&t.activate(m,0),d.appendChild(m),S(m),y(10)},w=r=>document.getElementById(r),x=(r,c=0)=>{const a=w(r.__microapp_traced_state__.historyTracerId);if(a)if(a.contentWindow){const m=l();if(a===m)return;if(m&&c<0&&m.getAttribute(P.backAction)==="reload"){a.contentWindow.location.reload(),S(a,c);return}L(a,c)}else S(a,c);else{const m=r.__microapp_traced_state__;A(m.url,m.historyTracerId,r.__microapp_traced_state__.data.attrs)}},I=r=>{r==null||r.dispatchEvent(new CustomEvent(rt.removeIframe))},l=()=>{for(const r of _())if(t.isActive(r))return r},L=(r,c=0)=>{var m,d,g;const a=l();t.activate(r,c),a&&(a!==r&&(t.inactivate(a,c),(m=a.contentWindow)==null||m.dispatchEvent(new Event(V.hide))),(d=r.contentWindow)==null||d.dispatchEvent(new Event(V.show)),c<0&&((g=r.contentWindow)==null||g.dispatchEvent(new Event(V.back)))),W(),c<0&&u()},T=r=>{J(r,c=>{window.document.title=c})},$=r=>{ut(r,c=>{let a=window.document.querySelector("head > link[rel='icon']");a||(a=window.document.createElement("link"),a.rel="icon",document.getElementsByTagName("head")[0].appendChild(a)),a.href=c})},F=r=>{const c=d=>{var i,o,h,f;if(!d)return{type:"non-exist"};const g=d.getAttribute("href");if(!g)return{type:"non-href"};if(g.startsWith("#"))return{type:"hash-link",target:d};if(X(r.location.href,d.href))return{type:"hash-change",target:d};if(r.location.href===d.href)return{type:"same-link",target:d};if(d.getAttribute("target")==="_blank")return{type:"open-new-tab",target:d};const E=H(d.href,t.rules);return E.ok?{type:"matched-link",target:d,backAction:(i=E.rule)==null?void 0:i.backAction,waitFor:(o=E.rule)==null?void 0:o.waitFor,timeout:(f=(h=E.rule)==null?void 0:h.timeout)==null?void 0:f.toString()}:{type:"unmatched-link",target:d}},a=d=>{let g=d;for(;g;){if(g.hasAttribute(P.enable))return!0;if(g.hasAttribute(P.disable))return!1;g=g.parentElement}return!0},m=d=>{var o,h,f,k;if(!d.target)return;const g=d.target,E=pt(g),i=c(E);if(a(g)||(window.location.href=((o=i.target)==null?void 0:o.href)||""),i.type==="same-link")r.location.reload();else if(i.type==="unmatched-link")window.location.href=i.target.getAttribute("href")||"";else if(i.type==="matched-link"){const R=i.target;if(R.hasAttribute("download"))return;const N=yt(R);d.preventDefault(),U(R.href,{[P.backAction]:(h=i.backAction)!=null?h:"",[P.timeout]:(f=i.timeout)!=null?f:"",[P.waitFor]:(k=i.waitFor)!=null?k:"",...N})}};r.document.addEventListener("click",m)};let O=!1;window.addEventListener("beforeunload",()=>{O=!0});const j=(r,c=0)=>{var R;const a=v(r);if(r.lingjie){c<0&&u();return}r.lingjie=z;const m=nt(a),d=()=>n.getCurrentState().__microapp_traced_state__.historyTracerId===a.id,g=Q(r,{historyTracerId:a.id,data:{attrs:m},onPushState:p=>{!d()||window.history.replaceState(p,"",r.location.href)},onReplaceState:p=>{!d()||window.history.replaceState(p,"",r.location.href)},onPopState:p=>{!d()||window.history.replaceState(p,"",r.location.href)},shouldClear:()=>O,shouldSave:()=>!O}),E=parseInt((R=a.getAttribute(P.timeout))!=null?R:"5000",10),o=(()=>{var N,M;const p=a.getAttribute(P.waitFor);if(!p){const st=H(r.location.href,t.rules);if(st.ok)return(M=(N=st.rule)==null?void 0:N.waitFor)!=null?M:"dom-ready"}return p!=null?p:"dom-ready"})(),h=p=>{if(!d())return;const N=n.getCurrentState();window.location.href!==r.location.href&&n.originalReplaceState(N,"",r.location.href),L(a,p)};let f=[];const k=(p=0)=>{it({initialize:N=>{bt(r,E,o,M=>(f=M,N()))},condition:()=>f.includes("matched")||f.includes("timeout")?!0:o==="fcp"?f.includes("fcp"):o==="dom-ready"?f.includes("dom-ready"):o==="loaded"?f.includes("loaded"):o?!!r.document.querySelector(o):!1,action:()=>{h(p)},timeoutAction:()=>{h(p)}})};r.document.addEventListener("DOMContentLoaded",()=>{T(r)}),a.addEventListener(rt.removeIframe,()=>{g.clearStorage(),t.destroy(a)}),k(c),F(r),T(r),$(r)},U=(r,c)=>{if(!H(r,t.rules).ok){window.location.href=r;return}r=new URL(r,window.location.href).href;const m=B(r,null,G(),"","default",{attrs:c!=null?c:{}});window.history.pushState(m,"",r),A(r,m.__microapp_traced_state__.historyTracerId,c)},z={replacePage:(r,c)=>{r=new URL(r,window.location.href).href;const a=B(r,null,G(),"","default",{attrs:c!=null?c:{}});window.history.replaceState(a,"",r)},addPage:U,redirect:r=>{window.location.replace(r)},goto:r=>{window.location.href=r},initWindow:j,historyTracer:n};return z},X=(e,t)=>{const{origin:n,pathname:u,hash:s}=new URL(e,window.location.href),{origin:_,pathname:v,hash:y}=new URL(t,window.location.href);return n===_&&u===v&&s!==y},gt=(e,t)=>{const n=document.createElement("iframe");return n.src=e,n.id=t,n.style.border="none",n.style.position="fixed",n.style.top="0px",n.style.left="0px",n.style.width="100%",n.style.height="100%",n.style.background="#ffffff",n},nt=(e,t={})=>{var u;const n=Object.values(P);for(const s of n)s in t||e.hasAttribute(s)&&(t[s]=(u=e.getAttribute(s))!=null?u:"");return t},yt=e=>{const t={};let n=e;for(;n;)nt(n,t),n=n.parentElement;return t},pt=e=>{let t=e;for(;t;){if(vt(t))return t;t=t.parentElement}},vt=e=>e.tagName==="A",bt=(e,t=5e3,n,u)=>{const s=[],_=[],v=()=>{for(const x of _)x.clear()},y=()=>u(s)?(v(),!0):!1;if(e.document.readyState==="interactive"){if(s.push("dom-ready"),y())return}else if(e.document.readyState==="complete"&&(s.push("dom-ready","loaded"),y()))return;if(e.PerformanceObserver){const x=e.PerformanceObserver,I=new x(l=>{l.getEntriesByName("first-contentful-paint").length>0&&(s.push("fcp"),y())});try{I.observe({type:"paint",buffered:!0}),_.push({name:"fcp",clear:()=>{I.disconnect()}})}catch{}}const S=()=>{s.includes("dom-ready")||(s.push("dom-ready"),y())};e.document.addEventListener("DOMContentLoaded",S,{once:!0}),_.push({name:"dom-ready",clear:()=>{e.document.removeEventListener("DOMContentLoaded",S)}});const A=()=>{s.includes("loaded")||(s.push("loaded"),y())};if(e.addEventListener("load",A,{once:!0}),_.push({name:"loaded",clear:()=>{e.removeEventListener("load",A)}}),n!=="loaded"&&n!=="dom-ready"&&n!=="fcp"&&n!=="timeout"){const x=e.MutationObserver;if(x){const I=new x(l=>{for(const L of l)if(L.type==="childList"&&e.document.querySelector(n)){s.push("matched"),y(),I==null||I.disconnect();return}});I.observe(e.document,{childList:!0,subtree:!0}),_.push({name:"matched",clear:()=>{I.disconnect()}})}}let w=setTimeout(()=>{s.push("timeout"),y()},isNaN(t)?5e3:t);return _.push({name:"timeout",clear:()=>{clearTimeout(w)}}),s},it=e=>{const{initialize:t,condition:n,action:u,interval:s=200,timeout:_=5e3,timeoutAction:v}=e;let y=!1,S=!1;const A=()=>y||S?!0:(clearTimeout(x),n()?(y=!0,clearTimeout(w),u(),!0):(x=setTimeout(A,s),!1)),w=setTimeout(()=>{S=!0,v==null||v(),clearTimeout(x)},_);let x=setTimeout(A,s);t==null||t(A)};(e=>{if(window.lingjie)throw new Error("Lingjie is already initialized");let{rules:t,...n}=window.__lingjie_shell_config__;t=(t||[]).map(function(S){return S.test=new RegExp(S.test),S});const u={paramKey:"lingjie_url",useGlobalVar:!0,rules:t,...n,...e},_=new URL(window.location.href).searchParams.get(u.paramKey);if(!_)throw new Error(`${u.paramKey} is required in query string`);history.replaceState(null,"",_);let v={...u};window.innerWidth<800&&!u.turnoffSlideAnimation&&Object.assign(v,mt);const y=_t(v);return window.lingjie=y,y.replacePage(_),y})()});
